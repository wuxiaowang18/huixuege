<?php
/**
 ***************************************************************************
 * å¤‡å¿˜å½•v1.0
 * ä½œè€…ï¼šé›ªå“¥
 * æ—¶é—´ï¼š2022-12-07
 ***************************************************************************
 * æ•°æ®åº“
 * db-title:Miss.å…°&Mrs.æœ›â¤ç•™è¨€æ¿
 * db-password:love
 * db-note:return array (0 =>array ('title' => '2022/12/07','content' => '<p>äº²çˆ±çš„å…°å…°ï¼Œç”Ÿæ—¥å¿«ä¹ğŸ°ğŸ°ğŸ°ï¼ï¼ï¼æ„¿å¤©å¤©å¼€å¿ƒï¼Œæˆ‘çˆ±ä½ ğŸ˜˜çˆ±ä½ å“ŸğŸ’</p>',),1 =>array ('title' => '2020/1/29','content' => '<p>ç›¸è¯†ï¼</p>',),2 =>array ('title' => '2020/5/20','content' => '<p>ç›¸çˆ±ï¼</p>',),3 =>array ('title' => '2020/6/25','content' => '<p>ç›¸è§ï¼</p>',),4 =>array ('title' => '2020/6/27','content' => '<p>ç¬¬ä¸€æ¬¡äº²äº²ï¼å˜»å˜»ï¼ï¼</p>',),5 =>array ('title' => '2020/8/1','content' => 'ç¬¬äºŒæ¬¡è§é¢ï¼Œå˜»å˜»ï¼',),6 =>array ('title' => '2020/10/1','content' => '<p>ä½ ç¬¬ä¸€æ¬¡æ¥å—æ˜Œè§æˆ‘ï¼Œå˜»å˜»ï¼</p>',),7 =>array ('title' => '2020/11/14','content' => 'ç¬¬å››æ¬¡è§é¢ï¼å˜¿å˜¿ï¼',),8 =>array ('title' => '2021/1/1','content' => 'ç¬¬äº”æ¬¡è§é¢å“¦ï¼å˜¿å˜¿ï¼',),9 =>array ('title' => '2021/2/20','content' => 'ç¬¬å…­æ¬¡è§é¢å“Ÿï¼çˆ±ä½ ğŸ˜˜',),10 =>array ('title' => '2021/4/3','content' => '<p>ç¬¬ä¸ƒæ¬¡è§é¢ï¼ŒğŸ˜˜</p>',),11 =>array ('title' => '2021/4/5','content' => '<p>ç¬¬ä¸€æ¬¡ä½ä½ å®¿èˆå“Ÿï¼</p>',),12 =>array ('title' => '2021/6/12','content' => 'ç¬¬äºŒæ¬¡ä½ä½ å®¿èˆå“Ÿï¼Œå˜»å˜»ï¼ï¼',),13 =>array ('title' => '2021/8/27','content' => '<p>ä½ æ¥å—æ˜Œäº†å“Ÿï¼</p>',),14 =>array ('title' => '2022/1/1','content' => '<p>ä½ æ¥å—æ˜Œäº†å“Ÿï¼Œå·®ç‚¹æ²¡æ¥åˆ°ï¼ğŸ¥º</p>',),15 =>array ('title' => '2022/1/31','content' => 'ç¬¬ä¸€æ¬¡æ¥æˆ‘å®¶æ¬¡é¥­é¥­ï¼Œå˜¿å˜¿ï¼',),16 =>array ('title' => '2022/2/2','content' => '<p>ç¬¬äºŒæ¬¡æ¥å¯¹è±¡å®¶ï¼</p>',),17 =>array ('title' => '2022/6/2','content' => '<p>ä½ æ¥å—æ˜Œäº†ï¼Œç”Ÿç—…äº†ğŸ¥º_@n@_</p>',),18 =>array ('title' => '2022/8/4','content' => '<p>ä½ æ¥å—æ˜Œäº†å“Ÿï¼ä¹°æˆ’æŒ‡å»ğŸ˜Š</p>',),19 =>array ('title' => '2022/10/1','content' => '<p>æˆ‘ä»¬è®¢å©šäº†ï¼Œå¼€å¿ƒå¼€å¿ƒï¼</p>',),20 =>array ('title' => '2022/10/31','content' => 'å»æ·±åœ³äº†ï¼Œä¸€å¹´å¤šæ²¡è¿‡å»äº†ã€‚',),21 =>array ('title' => '2023/1/20','content' => 'æ±‚å©šğŸ˜ŠğŸ’˜',),22 =>array ('title' => '2023/1/25','content' => '<p>ç»“å©šâŠ™Ï‰âŠ™</p>',),23 =>array ('title' => '2023/4/8','content' => '<p>æ‹ç»“å©šè¯ä»¶ç…§</p>',),);
 ***************************************************************************
 */
header('Content-Type: text/html; charset=utf-8');
date_default_timezone_set('PRC');
session_start();
define('LOGIN', isset($_SESSION['login'])?$_SESSION['login']:0);
define('AJAX',(isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower(trim($_SERVER['HTTP_X_REQUESTED_WITH']))=='xmlhttprequest'));
/**
 * ç±»å‹è·å–ä¸è½¬æ¢
 * è¯´æ˜ï¼šå¦‚æœ$dataä¸ºæ•°ç»„ç±»å‹ï¼Œå°†è½¬æ¢æ‰€æœ‰æ•°ç»„å€¼ä¸º$type
 * @param mixed $data æ•°æ®
 * @param string $type è½¬æ¢ç±»å‹ï¼Œä¸ºç©ºè¿”å›æ•°æ®ç±»å‹
 * @return mixed
 */

function type($data,$type=false){
	if(!isset($data) || $data===false || $data==='undefined' || (!$data && $data!==0 && $data!=='0') )return false;
	if(!$type)return gettype($data);
	if($type=='str' || $type=='string') {
		$data = (is_array($data) || is_object($data))?var_export($data,true):(string)$data;
	}elseif($type=='stripTags') {
		$data = strip_tags((string)$data);
	}elseif($type=='trim') {
		$data = trim((string)$data);
	}elseif($type=='int' || $type=='integer') {
		$data = intval($data);
	}elseif($type=='float'){
		$data = floatval($data);
	}elseif($type=='object'){
		if(is_object($data))return $data;
		if(is_array($data)){
			$data = json_decode(json_encode($data,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
		}elseif(is_string($data)){
			$data = json_decode($data);
		}else{
			$data = (object)$data;
		}
	}elseif($type=='array'){
		if(is_array($data))return $data;
		if(is_object($data)){
			$data = json_decode(json_encode($data,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),true);
		}elseif(is_string($data)){
			$data = json_decode($data,true);
		}else{
			$data = (array)$data;
		}
	}elseif($type=='bool'){
		$data=trim($data);
		if($data=='true' || $data=='1'){
			$data=true;
		}elseif($data=='false' || $data=='null' || $data=='0'){
			$data=false;
		}else{
			$data=boolval($data);
		}
	}elseif($type=='json'){
		//ç¬¬äºŒä¸ªå‚æ•°ï¼šè½¬ä¸ºUnicodeç¼–ç | 
		$data=is_array($data)||is_object($data)?json_encode($data,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES|JSON_NUMERIC_CHECK):false;
	}
	return isset($data)?$data:false;
}
/**
 * è·å–URLä¸Šå‚æ•°å’Œ$_GETå‚æ•°
 * @param string|int $key æ•°æ®çš„KEYï¼Œä¸ºç©ºå°†è·å–æ‰€æœ‰å‚æ•°
 * @param string $type æ•°æ®è½¬æ¢ç±»å‹ï¼Œä¸ºç©ºé»˜è®¤ä¸ºå­—ç¬¦ä¸²ï¼Œæœ‰æ•ˆå€¼å‚è€ƒtypeæ–¹æ³•
 * @param mixed $def è·å–çš„getä¸å­˜åœ¨çš„è¯ï¼Œè¿”å›è¯¥è®¾å®šæ•°å€¼
 * @return mixed
 */
function get($key=false,$type=false,$def=false){
	if($key===false)return $_GET;
	if(!isset($_GET[$key]))return $def!==false?$def:false;
	if(!$type)return $_GET[$key];
	return type($_GET[$key],$type);
}
/**
 ****************************************************************************
 * åŠŸèƒ½ï¼šè·å–$_POSTå‚æ•°å¹¶å®‰å…¨è½¬æ¢ç±»å‹
 * @param $key  {string}  æ•°æ®çš„KEYï¼Œä¸ºç©ºå°†è·å–æ‰€æœ‰å‚æ•°
 * @param $type {string}      æ•°æ®è½¬æ¢ç±»å‹ï¼Œä¸ºç©ºé»˜è®¤ä¸ºå­—ç¬¦ä¸²ï¼Œæœ‰æ•ˆå€¼å‚è€ƒtypeæ–¹æ³•
 * @param $def  {mix}         è·å–çš„postä¸å­˜åœ¨çš„è¯ï¼Œé»˜è®¤è¿”å›è¯¥æ•°å€¼
 * @return mix
 ****************************************************************************
 */
function post($key=false,$type=false,$def=false){
	if($key===false)return $_POST;
	if(!isset($_POST[$key]))return $def!==false?$def:false;
	if(!$type)return $_POST[$key];
	return type($_POST[$key],$type);
}
/**
 * æ‰“å°æ¶ˆæ¯
 * @param bool $error çŠ¶æ€ä»£ç æˆ–æ¶ˆæ¯
 * @param mixed $data å¦‚æœä¸ºç©ºï¼Œé»˜è®¤ç›´æ¥æ‰“å°æ¶ˆæ¯ï¼Œå¤šç”¨äºAJAX
 */
function ajax($error, $data=false) {
	echo json_encode(['error'=>$error, 'data'=>$data],JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES|JSON_NUMERIC_CHECK);
	exit;
}
/**
 * ä¿å­˜æ•°æ®
 * @param string $name æ•°æ®åº“åç§°
 * @param string $content å†…å®¹
 */
function save($name,$content){
	$fileContent = file_get_contents(__FILE__);
	$pattern='/\s\*\sdb-'.$name.':.*/';
	$fileContent = preg_replace($pattern, ' * '.'db-'.$name.':'.$content, $fileContent);
	file_put_contents(__FILE__,$fileContent);
}

//é¡µé¢è·¯ç”±
$page = get('page','string');

//è·å–å½“å‰æ–‡ä»¶å†…å®¹
$fileContent = file_get_contents(__FILE__);

//è·å–æ•°æ®åº“ä¿¡æ¯
preg_match_all('/\s\*\sdb-(.*?):(.*)/', $fileContent, $matches);
$db = [];
if(isset($matches[1]) && isset($matches[2])){
	foreach ($matches[1] as $k => $v) {
		$db[$v] = trim($matches[2][$k]);
	}
}

//é¡µé¢è·¯ç”±
$page = post('page','string');
$type = post('type','string');

if(AJAX){
	//ç™»å½•
	if($page == 'login'){
		$password = post('password','string',false);
		if($password === $db['password']){
			$_SESSION['login'] = 1;
			ajax(0,'ç™»å½•æˆåŠŸ');
		}
		ajax(1,'å¯†ç ä¸æ­£ç¡®');
	}
	//é€€å‡º
	elseif($page == 'logout'){
		unset($_SESSION['login']);
	    unset($_SESSION);
	    session_destroy();
	    ajax(0,'æ³¨é”€æˆåŠŸ');
	}
	//å¤‡å¿˜å½•
	else{
		if(!LOGIN) ajax(1,'è¯·ç™»å½•');
		//è®¾ç½®
		if($page == 'setting'){
			$title = post('title','string',false);
			$password = post('password','string',false);
			if($title) save('title',$title);
			if($password) save('password',$password);
			ajax(0,'ä¿®æ”¹æˆåŠŸ');
		}
		if($page == 'note'){
			//è·å–
			if($type == 'get'){
				$db['note'] = str_replace('_@n@_',"\n",$db['note']);
				ajax(0,eval($db['note']));
			}
			//æ›´æ–°
			elseif($type == 'update'){
				$key = post('key','int',false);
				$field = post('field','string',false);
				$content = post('content','string',false);
				if($key !== false && $field){
					$content = str_replace("\n", '_@n@_', $content);
					$db['note'] = eval($db['note']);
					$db['note'][$key][$field] = $content;
					$value = var_export(array_values($db['note']),true);
					$value = explode("\n", $value);
					foreach($value as &$v){
						$v = trim($v);
					}
					$value = implode('', $value);
					save('note','return '.$value.';');
					ajax(0,'ä¿å­˜æˆåŠŸ');
				}
				ajax(1,'ç³»ç»Ÿå‡ºé”™');
			}
			//åˆ é™¤
			elseif($type == 'delete'){
				$key = post('key','int',false);
				if($key !== false){
					$db['note'] = eval($db['note']);
					unset($db['note'][$key]);
					$value = var_export(array_values($db['note']),true);
					$value = explode("\n", $value);
					foreach($value as &$v){
						$v = trim($v);
					}
					$value = implode('', $value);
					save('note','return '.$value.';');
					ajax(0,'ä¿å­˜æˆåŠŸ');
				}
				ajax(1,'ç³»ç»Ÿå‡ºé”™');
			}
		}
	}
}
?>
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0"/>
	<title><?php echo $db['title'];?></title>
	<script src="wp-content\themes\begin\static25\ice.js"></script>
	<style>
		*{margin:0;padding:0;font-family:Tahoma,Arial,sans-serif,'Microsoft YaHei';font-size:15px;box-sizing:border-box;}
		body{color:#373e4e;background:#f5f5f5;margin:50px 30px 150px;}
		*::selection{color:#fff;background-color:#4f9552;}
		input::-webkit-input-placeholder,textarea::-webkit-input-placeholder{color:#c5c5c5;}
		input{color:#525d76;resize:none;outline:none;height:25px;line-height:25px;padding:0 10px;box-sizing:border-box;border:1px solid #9f9f9f;vertical-align:middle;border-radius:2px;}
		a{color:#373e4e;}
		a:hover{color:#57af4c;text-decoration:underline;}
		.btn{color:white;background-color:#373e4e;padding:0 25px;border:none;height:25px;line-height:25px;margin:10px 0;display:inline-block;text-decoration:none!important;cursor:pointer;vertical-align:middle;border-radius:2px;}
		.btn:hover{color:#ffffff;background-color:#5e6779;}
		.title{text-align:center;font-size:27px;margin-bottom:20px;}
		.prompt{margin-top:10px;}
		.login{text-align:center;background:#fff;width:500px;margin:0 auto;padding:30px;border-radius:4px;}
		.note{width:40%;margin:auto;}
		.tip{margin:10px;background:#fff;border-radius:4px;padding:0 10px;position:relative;}
		.tip-title{padding:10px;padding-bottom:0;height:40px;display:flex;align-items:center;font-weight:bold;outline:none;-webkit-user-modify:read-write;-webkit-user-modify:read-write-plaintext-only;}
		.tip-title a{margin-left:10px;text-decoration:none;font-weight:normal;}
		.tip-title a:first-child{margin-left:auto;}
		.tip-close{position:absolute;right:20px;top:15px;cursor:pointer;}
		.tip-content{padding:10px;padding-top:0;color:#444;outline:none;-webkit-user-modify:read-write;white-space:pre-wrap;-webkit-user-modify:read-write-plaintext-only;word-break: break-all;}
		.tip-content p{margin:3px 0;}
		.tool{position:fixed;top:120px;left:calc(70% + 20px);}
		.tool-btn{background:#4caf50;color:#fff;height:50px;width:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-family:initial;font-weight:300;cursor:pointer;margin-bottom:10px;}
		.tool-btn:hover{background:#318334;}
		#logout,#setting{background:#a2a8ba;}
		#logout:hover,#setting:hover{background:#858ca1;}
		.form{margin:10px 0;padding:0 10px;display:flex;}
		.key{display:inline-block;text-align:right;padding-right:10px;vertical-align:top;line-height:25px;}
		.value{flex:1;line-height:25px;}
		.value input[type=text],.value input[type=password],.value input[type=number]{width:100%;}
		.setting {text-align: center;position: fixed;top: 0;left: 0;right: 0;bottom: 0;margin: auto;width: 400px;height: 200px;background: #fff;padding: 15px;box-shadow: 0 0 15px rgb(0 0 0 / 18%);border-radius: 4px;display:none;}
		.setting-close {position: absolute;top: 15px;right: 15px;cursor: pointer;}
		.setting-title {text-align: left;font-weight: bold;margin-bottom: 20px;}
		@media (max-width:768px){
		    body{margin: 20px 0 150px;}
		    .note{width:100%;margin:auto;}
		    .tool{top:initial;left:initial;bottom:50px;right:30px;}
		}
	</style>
</head>
<body>
	<div class="title"><?php echo $db['title'];?></div>
	<?php if(!LOGIN){ ?>
	<div class="login">
		<input type="password" name="password" placeholder="å¯†ç ç™»å½•"/>
		<input type="submit" class="btn" value="ç¡®è®¤"/>
		<div class="prompt">è¯·è¾“å…¥å¯†ç </div>
	</div>
	<script>
		//ç™»å½•
		ice('[type=submit]').click(function(){
			ice.ajax(window.location.href,{page:'login',password:ice('[name=password]').val()}).then(res=>{
				if(res.error){
					ice('.prompt').html(res.data);
				}else{
					location.reload();
				}
			})
		})
	</script>
	<?php }else{ ?>
	<div class="note">
		<div id="note-list"></div>
	</div>
	<div class="tool">
		<div class="tool-btn" id="note-add">æ·»åŠ </div>
		<div class="tool-btn" id="setting">è®¾ç½®</div>
		<div class="tool-btn" id="logout">é€€å‡º</div>
	</div>
	<div class="setting">
		<div class="setting-title">è®¾ç½®</div>
		<div class="setting-close">âœ•</div>
		<div class="form">
	        <div class="key">ç½‘ç«™æ ‡é¢˜</div>
	        <div class="value">
	            <input type="text" name="title" placeholder="ç½‘ç«™æ ‡é¢˜" value="<?php echo $db['title'];?>"/>
	        </div>
	    </div>
	    <div class="form">
	        <div class="key">ç™»å½•å¯†ç </div>
	        <div class="value">
	            <input type="text" name="password" placeholder="ç™»å½•å¯†ç " value="<?php echo $db['password'];?>"/>
	        </div>
	    </div>
	    <div class="btn" onclick="setting()">ç¡®å®š</div>
	</div>
	<script>
		// æ·»åŠ 
		ice('#note-add').click(function(){
			ice('#note-list').append(`<div class="tip"><div class="tip-title">æ ‡é¢˜</div><div class="tip-close">âœ•</div><div class="tip-content"><p>å†…å®¹</p></div></div>`);
			noteInit();
			ice.setScrollB();
		})
		// è®¾ç½®
		ice('#setting').click(function(){
			ice('.setting').show();
		})
		ice('.setting-close').click(function(){
			ice('.setting').hide();
		})
		// é€€å‡º
		ice('#logout').click(function(){
			ice.ajax(window.location.href,{page:'logout'}).then(res=>{
				location.reload();
			})
		})
		function setting(){
			ice.ajax(window.location.href,{page:'setting',title:ice('[name=title]').val(),password:ice('[name=password]').val()}).then(res=>{
				location.reload();
			})
		}

		function noteInit(){
			ice('.tip-title').each(function(i){
				ice(this).attr('data-key',i)
				this.oninput = function(){
					ice.ajax(window.location.href,{page:'note',type:'update',key:i,field:'title',content:this.innerHTML.replace(/<[^>]*>/,'')});
				}
			})
			ice('.tip-content').each(function(i){
				ice(this).attr('data-key',i)
				this.oninput = function(){
					ice.ajax(window.location.href,{page:'note',type:'update',key:i,field:'content',content:this.innerHTML.replace('\n','_@n@_')});
				}
			})
			ice('.tip-close').each(function(i){
				ice(this).attr('data-key',i)
				this.onclick = function(){
					if(confirm('ç¡®å®šåˆ é™¤è¯¥ç¬”è®°å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')){
						ice('.tip').i(i).del();
						ice.ajax(window.location.href,{page:'note',type:'delete',key:i}).then(res=>{
							noteInit();
						})
					}
				}
			})
		}
		//è·å–å¤‡å¿˜å½•ä¿¡æ¯
		ice.ajax({
			url:window.location.href,
			data:{page:'note',type:'get'},
			success:function(res){
				if(!res.error){
					var html = '';
					res.data.forEach((v,k)=>{
						html += `<div class="tip"><div class="tip-title">${v.title ? v.title : ''}</div><div class="tip-close">âœ•</div><div class="tip-content">${v.content ? v.content : ''}</div></div>`
					})
					ice('#note-list').html(html);
					noteInit();
				}
			}
		})
	</script>
	<?php } ?>
</body>
</html>